# 多層式 DDoS 防禦系統之實作與評估

作者：—  日期：2025-11-29  環境：Windows + Python 3.11

## 摘要
本研究實作一套以 Python ThreadingHTTPServer 為基礎之多層 DDoS 防禦系統，整合 IP 黑名單（30 秒封鎖）、10 秒滑動視窗速率限制（20 req/10s）、每 IP 連線數上限與請求驗證等機制，並建立多種攻擊工具（HTTP Flood、SYN Flood、無標頭請求）進行壓力測試。實驗顯示：
- 修正 POST 攻擊在防禦前先讀取請求體後，可避免 TCP 緩衝阻塞，顯著降低延遲並提升吞吐。
- 應用層（HTTP）攻擊會被快速回覆 403/429 而非拖慢伺服器；網路層（SYN Flood）在 OS 防護（SYN cookies）下對網頁回應影響有限。
- 在多線程情境下，系統可維持高回覆率與低錯誤率，並在高並發下仍能有效攔截惡意流量。

## 1. 研究背景與動機
DDoS 攻擊可由網路層（如 SYN Flood）或應用層（HTTP Flood）發起。單一層次防護常不足，因此本研究結合多層機制並以可觀測性（10 秒滑動視窗）衡量即時負載，藉由真實壓力測試評估效果。

## 2. 系統設計
- 伺服器：`server_defense.py`（監聽 `0.0.0.0:8001`）
  - IP 黑名單：超限即封 30 秒。
  - 速率限制：10 秒滑動視窗，預設 20 req/10s。
  - 連接上限：限制單 IP 並發連線數。
  - 請求驗證：檢查必要標頭與方法，異常快速拒絕。
  - POST/PUT 請求：在防禦判斷前先讀取 `Content-Length` 指定長度之請求體，避免 TCP 緩衝殘留導致客戶端超時。
- 監控：即時請求速率（10 秒窗口）、近期請求與攔截原因統計、效能報表輸出。

## 3. 指標與量測方法
- 延遲（Latency）：客戶端端到端量測  \( L = t_{resp} - t_{send} \)。
- 吞吐量/速率（Throughput）：\( R = \frac{N_{req}}{T} \) req/s。
- 成功率（Success Rate）：\( S = \frac{N_{success}}{N_{success}+N_{fail}} \)。說明：本研究以「成功收到伺服器回應（含 403/429）」視為成功，以便評估可用性與防護效率（快速拒絕亦屬成功地保護資源）。

## 4. 實驗工具與攻擊模型
- HTTP Flood：`http_flood_attack.py`（完整 TCP + HTTP），多 UA/標頭、隨機參數避免快取，可觸發應用層防禦。
- 多客戶端模擬：`multi_client_attack.py`（多執行緒、多 UA），針對 `http://192.168.0.201:8001` 測試。
- 偽造 IP 的 SYN Flood：`spoofed_ip_attack.py`（Scapy，需管理員權限）於網路層產生大量 SYN，但通常不影響應用層延遲。
- 無標頭請求：模擬不完整/異常 HTTP 請求（NO_HEADERS）。

## 5. 實驗設定
- 作業系統：Windows；Python 3.11；多執行緒 HTTP 伺服器。
- 伺服器位址：`0.0.0.0:8001`，LAN：`192.168.0.201`，本機：`127.0.0.1`。
- 測試參數：
  - 線程數：10、20、30、50、75、100、150、200、300（逐步增加）
  - POST 請求體：1,000 bytes（用以測試「先讀取再拒絕」之效益）
  - 超時：5 秒；指標每 2 秒更新一次。

### 5.1 防禦機制詳解與有無防禦差異
| 防禦機制 | 核心邏輯 | 未啟用時行為 | 啟用後行為 | 觀察差異 (示例數據) |
|----------|----------|--------------|------------|--------------------|
| 10 秒滑動視窗速率限制 | 追蹤 IP 請求時間戳，超過閾值返回 429 | 單一 IP 可瞬間大量佔用執行緒，延遲急升 | 超過閾值立即 429，執行緒釋放 | GET 300 線程吞吐由 566.2 提升至 2057.9 req/s (≈3.63×)，平均延遲由 559.4 降至 259.1 ms (≈-53.7%) |
| IP 黑名單 (30 秒) | 違規 IP 加入暫存封鎖集合 | 重複觸發速率限制仍持續進入判斷邏輯 | 直接 403，處理時間 <1ms | 大量重複來源時 CPU 使用率更平穩；攔截率高且延遲曲線平滑 |
| 連線數限制 | 計數每 IP 活躍連線，超出拒絕 | 高並發可能導致 TIME_WAIT / 執行緒飽和 | 超出立即拒絕，避免資源耗竭 | netstat 顯示有限少量 TIME_WAIT，無爆量半開連線 |
| 請求驗證 (標頭/方法) | 檢查必要標頭 + 方法合法性 | 異常/殘缺請求可能進入模板渲染 | 快速 403，降低 I/O 與解析成本 | NO_HEADERS 模式延遲隨並發上升較緩，吞吐保持穩定 |
| POST 請求體預先讀取與丟棄 | 先依 Content-Length 讀取再判斷 | 客戶端繼續推送資料→TCP 回壓→超時 | 迅速讀取丟棄後回覆 403/429 | POST 300 線程吞吐由修正前低迷(易超時)至 1681.0；防禦開啟後 1875.0 (+11.6%) |

說明：表中「未啟用」之情境為對應邏輯暫停或缺失的理論/早期狀態；「示例數據」引用部份測試結果，用於量化防禦帶來的效益。速率限制+黑名單組合提供兩段式壓制（短期節流 + 中期封鎖），有效避免單一來源持續壓力。POST 預讀策略屬於應用層優化，直接改善 TCP 緩衝壓力，減少超時。

#### 防禦鏈運作流程 (請求進入至回應)
```
請求到達 → 取得 IP / 方法 / 標頭 → 檢查黑名單 → 檢查連線數 → (必要) 讀取請求體 → 速率窗口更新與判斷 → 驗證標頭與方法 → 通過則進入業務邏輯，否則即時 403/429
```

#### 延遲與資源消耗對比摘要
- 無防禦下延遲曲線呈近線性或加速成長（執行緒競爭 + I/O 堆疊）。
- 啟用防禦後延遲成長斜率明顯下降（大量惡意請求在「極薄」處理管線結束）。
- 吞吐提升主因：拒絕路徑極短 → 單位時間可處理更多「請求事件」，合法請求排程更穩定。
- 防禦開銷：少量 Python 字典/集合操作 + 時間戳維護，對高並發延展性影響極低（觀察中未出現明顯 CPU 飽和）。

#### 防禦策略取捨
- IP 黑名單時長過長可能誤傷短暫突發的合法客戶端；30 秒作為折衷（緩衝期 + 自動解封）。
- 速率限制窗口過短易造成抖動；10 秒窗口兼顧響應平滑度與動態性。
- 連線數限制須配合 OS backlog 調整（本實作未深入調整內核參數，屬應用層保護）。

#### 潛在改進方向
- 引入「自適應閾值」：根據最近平均延遲與錯誤率自動調整 req/10s。
- 黑名單分級：多次違規延長封鎖，偶發違規快速解封。
- 統計分離：合法與惡意請求各自獨立窗口，避免惡意流量稀釋合法速率判斷。


## 6. 實驗結果
為便於視覺化理解，我們提供延遲與吞吐量的折線圖（以不同線程數為橫軸）。可透過 `report/plot_results.py` 生成並保存 PNG。

生成圖表：
```powershell
python topic/DDos/report/plot_results.py
```

產生檔案：`fig_latency_get.png`, `fig_throughput_get.png`, `fig_latency_post.png`, `fig_throughput_post.png`, `fig_latency_noh.png`, `fig_throughput_noh.png`

### 圖 1：GET 延遲與吞吐
![GET Latency](fig_latency_get.png)

![GET Throughput](fig_throughput_get.png)

### 圖 2：POST 延遲與吞吐（修正後/啟防禦）
![POST Latency](fig_latency_post.png)

![POST Throughput](fig_throughput_post.png)

### 圖 3：NO_HEADERS 延遲與吞吐
![NO_HEADERS Latency](fig_latency_noh.png)

![NO_HEADERS Throughput](fig_throughput_noh.png)
### 6.1 GET 攻擊（代表應用層拒絕快速、資源回收有效）
（節錄）
- 10 線程｜成功 926｜失敗 0｜延遲 87.1 ms｜速率 115.8 req/s｜🟢
- 100 線程｜成功 2150｜失敗 0｜延遲 385.3 ms｜速率 268.8 req/s｜🟢
- 300 線程｜成功 4530｜失敗 0｜延遲 559.4 ms｜速率 566.2 req/s｜🟡

解析：多數請求被快速拒絕（403/429），因此整體「成功收到回應」比例高且延遲隨負載溫和上升，顯示防禦能快速釋放資源。

### 6.2 POST 攻擊（修正前後對照）
修正前：伺服器在判斷前未讀取請求體→客戶端仍持續發送 1,000 bytes，TCP 緩衝回壓導致連線變慢與超時。

修正（於判斷前讀取 `Content-Length` 指定長度並丟棄）：
- 10 線程｜成功 7367｜失敗 0｜延遲 10.9 ms｜速率 920.9 req/s｜🟢
- 100 線程｜成功 6555｜失敗 1｜延遲 134.4 ms｜速率 819.4 req/s｜🟢
- 300 線程｜成功 13448｜失敗 0｜延遲 308.3 ms｜速率 1681.0 req/s｜🟢

解析：修正後大幅降低延遲且顯著提升吞吐，證明「先讀取再拒絕」可避免 TCP 層緩衝阻塞。

### 6.3 無標頭（NO_HEADERS）攻擊
- 10 線程｜成功 788｜延遲 104.4 ms｜速率 98.5 req/s｜🟢
- 100 線程｜成功 2027｜延遲 409.5 ms｜速率 253.4 req/s｜🟢
- 300 線程｜成功 4859｜延遲 514.8 ms｜速率 607.4 req/s｜🟡

解析：異常請求被快速識別並拒絕，隨並發上升延遲增加有限。

### 6.4 啟用防禦的綜合結果（節錄）
GET：
- 10/20/50/100/200/300 線程｜速率約 901.1 / 807.6 / 1032.4 / 1088.8 / 1413.4 / 2057.9 req/s，延遲 11.1–259.1 ms，全部 🟢。

POST：
- 10/50/100/200/300 線程｜速率約 395.0 / 683.2 / 676.8 / 1142.2 / 1875.0 req/s，延遲 25.4–398.6 ms，幾近全綠。

NO_HEADERS：
- 10/50/100/200/300 線程｜速率約 388.1 / 707.4 / 697.2 / 1222.4 / 1577.9 req/s，延遲 26.1–594.5 ms，多數 🟢。

整體觀察：防禦開啟後，伺服器以低延遲快速拒絕惡意流量，吞吐顯著提升，錯誤率極低。

### 6.5 SYN Flood（偽造源 IP）
以 Scapy 發送 ~6,220 個來自不同偽造 IP 的 SYN 封包（30 秒，~500 pps）。
- 應用層觀察：幾乎無卡頓，`netstat` 無大量半開連線；Windows SYN cookies 生效。
- 建議以 Wireshark 以 `tcp.port == 8001 && tcp.flags.syn == 1` 觀測網路層流量。

## 7. 討論
- 快速拒絕與回應（403/429）可視為成功地釋放資源，避免佔用工作執行緒和 I/O。
- 先讀取 POST 請求體再判斷能避免 TCP 背壓造成的延遲/超時，是應用層防禦實務關鍵。
- 網路層（SYN）防護多倚賴 OS/防火牆；應用層防禦擅長對抗 HTTP Flood 與異常流量。

## 8. 限制
- 同機測試源 IP 受限（localhost/同一 LAN），多來源真實 HTTP 攻擊需跨裝置或異地。
- 實驗著重 HTTP 層，對放大型攻擊（DNS/SSDP/NTP）未納入。

## 9. 未來工作
- 加入 UDP/ICMP Flood、SSL 握手放大、DNS 放大、WordPress pingback 等攻擊模組。
- 以多台機器與不同 AS/ISP 來源進行大規模實測。
- 引入自動化調參與自適應防禦（動態調整速率閾值、黑名單時長）。
- 儀表板與告警：即時可視化請求速率、攔截原因、阻擋 IP、網路出送速率。

## 10. 結論
本研究展示了可在一般環境下快速部署與驗證的多層 DDoS 防禦系統。實驗證明：對應用層攻擊，快速讀取請求體並立即拒絕可有效降低延遲並提升吞吐；對網路層攻擊，作業系統機制（如 SYN cookies）提供第一層保護。未來將擴充攻擊型態與多來源情境以進一步驗證防禦韌性。

---

### 附錄 A：重現步驟（擇要）
```powershell
# 啟動防禦伺服器（監聽 0.0.0.0:8001）
python server_defense.py

# HTTP Flood（應用層）
python http_flood_attack.py

# 多客戶端（應用層）
python multi_client_attack.py

# SYN Flood（偽造 IP，需要管理員與 Npcap）
python spoofed_ip_attack.py
```

### 附錄 B：關鍵修正（POST 請求）
```python
# 如果是 POST/PUT/PATCH，先讀取請求體再判斷
if request_method in ['POST', 'PUT', 'PATCH']:
    content_length = int(self.headers.get('Content-Length', 0))
    if content_length > 0:
        self.rfile.read(content_length)
```

## 參考文獻
- RFC 4987: TCP SYN Flooding Attacks and Common Mitigations.
- RFC 7323: TCP Extensions for High Performance（SYN cookies 背景延伸）。
- M. Prince, “Defending Against Layer 7 DDoS Attacks,” Cloudflare Blog, 2017.
- A. Popov et al., “Transport Layer Security (TLS) 1.3,” RFC 8446, 2018。
- OWASP: Denial of Service Cheat Sheet。
